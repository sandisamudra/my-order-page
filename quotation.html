<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quotation</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h2 { margin-top: 40px; text-align: left; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #000; padding: 8px; text-align: left; }
    .signature-pad { border: 1px solid #000; width: 100%; height: 200px; }
    .button-group { margin-top: 10px; }
    .button-group button { margin-right: 10px; }
    @media print {
      #signature-pad, .button-group { display: none; }
    }
    #print-btn {
      position: fixed; top: 20px; right: 20px;
      padding: 10px 20px; background: black; color: white; border: none; cursor: pointer;
    }
  </style>
</head>
<body>

  <button id="print-btn" onclick="window.print()">Print</button>

  <h1 id="project-name"></h1>
  <h3 id="user-name"></h3>

  <h2>Equipments</h2>
  <div id="equipment-section"></div>
  <h3>Total Cost Equipments: <span id="total-cost-orders"></span></h3>

  <h2>Guard and Others</h2>
  <table id="guard-table">
    <thead>
      <tr>
        <th>Subject</th><th>Cost</th><th>Quantity</th><th>Day</th><th>Amount</th>
      </tr>
    </thead>
    <tbody id="guard-body"></tbody>
  </table>
  <h3>Total Cost Guard and Others: <span id="total-cost-go"></span></h3>

  <h3>Discount: <span id="discount"></span></h3>
  <h2>Grand Total: <span id="grand-total"></span></h2>

  <h3>Customer Signature</h3>
  <canvas id="signature-pad" class="signature-pad"></canvas>
  <div class="button-group">
    <button onclick="clearSignature()">Clear</button>
    <button onclick="saveSignature()">Save</button>
  </div>
  <div id="saved-signature"></div>
  <p id="username"></p>

  <script>
    // jika sudah berisi huruf (IDR, USD, %), tampil apa adanya
    function formatCurrency(value) {
      if (/[^\d,]/.test(value)) return value;
      const n = parseInt(value, 10);
      if (isNaN(n)) return value;
      return n.toLocaleString("id-ID") + " IDR";
    }

    function parseJoinedList(list) {
      return list
        ? decodeURIComponent(list).split("||").map(item => item.split("|"))
        : [];
    }

    function groupByCategory(data) {
      const groups = {};
      data.forEach(item => {
        const [name, category, cost, qty, day, amount] = item;
        if (!groups[category]) groups[category] = [];
        groups[category].push([name, cost, qty, day, amount]);
      });
      return groups;
    }

    function loadData() {
      const params = new URLSearchParams(window.location.search);
      const project = params.get("project") || "";
      const user = params.get("user") || "";
      const orders = parseJoinedList(params.get("orders"));
      const guardorders = parseJoinedList(params.get("guardorders"));
      // ambil parameter apa adanya
      const totalEquipments = params.get("totalcostorders") || "0";
      const totalGuards = params.get("totalcostGO") || "0";
      const discount = params.get("discount") || "";
      const grandTotal = params.get("grandtotal") || "";

      document.getElementById("project-name").textContent = project;
      document.getElementById("user-name").textContent = Customer: ${user};
      document.getElementById("discount").textContent = discount;

      // *HANYA DI SINI DI-UPDATE*
      document.getElementById("total-cost-orders").textContent =
        formatCurrency(totalEquipments);
      document.getElementById("total-cost-go").textContent =
        formatCurrency(totalGuards);
      document.getElementById("grand-total").textContent =
        formatCurrency(grandTotal);

      // Equipments grouped by category
      const grouped = groupByCategory(orders);
      const equipmentContainer = document.getElementById("equipment-section");
      Object.entries(grouped).forEach(([cat, items]) => {
        const tbl = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML = `
          <tr><th colspan="5">${cat}</th></tr>
          <tr>
            <th>Item</th><th>Cost</th><th>Quantity</th><th>Day</th><th>Amount</th>
          </tr>`;
        tbl.appendChild(thead);

        const tbody = document.createElement("tbody");
        items.forEach(([name,, cost, qty, day, amount]) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${name}</td>
            <td>${formatCurrency(cost)}</td>
            <td>${qty}</td>
            <td>${day}</td>
            <td>${formatCurrency(amount)}</td>`;
          tbody.appendChild(tr);
        });
        tbl.appendChild(tbody);
        equipmentContainer.appendChild(tbl);
      });

      // Guard and Others
      const guardBody = document.getElementById("guard-body");
      guardorders.forEach(([subject, cost, qty, day, amount]) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${subject}</td>
          <td>${formatCurrency(cost)}</td>
          <td>${qty}</td>
          <td>${day}</td>
          <td>${formatCurrency(amount)}</td>`;
        guardBody.appendChild(tr);
      });
    }

    // setup signature pad (touch & mouse)
    const canvas = document.getElementById("signature-pad");
    const ctx = canvas.getContext("2d");
    let drawing = false;

    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      const x = e.touches ? e.touches[0].clientX : e.clientX;
      const y = e.touches ? e.touches[0].clientY : e.clientY;
      return { x: x - rect.left, y: y - rect.top };
    }
    function startDraw(e) {
      drawing = true;
      const pos = getPos(e);
      ctx.beginPath(); ctx.moveTo(pos.x, pos.y);
      e.preventDefault();
    }
    function draw(e) {
      if (!drawing) return;
      const pos = getPos(e);
      ctx.lineTo(pos.x, pos.y); ctx.stroke();
      e.preventDefault();
    }
    function stopDraw(e) {
      drawing = false; e.preventDefault();
    }

    ["mousedown","touchstart"].forEach(evt =>
      canvas.addEventListener(evt, startDraw, { passive: false }));
    ["mousemove","touchmove"].forEach(evt =>
      canvas.addEventListener(evt, draw, { passive: false }));
    ["mouseup","mouseleave","touchend"].forEach(evt =>
      canvas.addEventListener(evt, stopDraw, { passive: false }));

    function clearSignature() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      document.getElementById("saved-signature").innerHTML = "";
    }
    function saveSignature() {
      const dataURL = canvas.toDataURL();
      document.getElementById("saved-signature").innerHTML =
        <img src="${dataURL}" style="max-width:100%"/>;
    }

    window.onload = loadData;
  </script>
</body>
</html>
