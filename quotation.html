<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quotation</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    h2 { text-align: left; margin-top: 40px; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
    .totals { font-weight: bold; margin-top: 10px; }
    .signature-pad-container { margin-top: 40px; }
    .signature-area {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      max-width: 300px;
    }
    canvas {
      border: 1px solid #000;
      width: 100%;
      height: 150px;
      touch-action: none;
    }
    .btn-group {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }
    #signature-preview {
      margin-top: 10px;
      border: 1px solid #ccc;
    }
    #print-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 20px;
      background-color: black;
      color: white;
      border: none;
      cursor: pointer;
    }
    @media print {
      #print-btn, .signature-area, .btn-group { display: none !important; }
    }
  </style>
</head>
<body>
  <button id="print-btn" onclick="window.print()">Print</button>

  <h1 id="project-title">Project Name</h1>
  <h3 id="user-name">Customer: </h3>

  <h2>Equipments</h2>
  <div id="equipments-table-container"></div>
  <div class="totals">Total Cost Equipments: <span id="total-equipments-cost"></span></div>

  <h2>Guard and Others</h2>
  <table id="guard-table">
    <thead>
      <tr>
        <th>Subject</th>
        <th>Cost</th>
        <th>Quantity</th>
        <th>Day</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody id="guard-body"></tbody>
  </table>
  <div class="totals">Total Cost Guard and Others: <span id="total-guard-cost"></span></div>

  <div class="totals">Discount: <span id="discount-val"></span></div>
  <div class="totals">Grand Total: <span id="grand-total-val"></span></div>

  <div class="signature-pad-container">
    <h3>Customer Signature</h3>
    <div class="signature-area">
      <canvas id="signature-pad"></canvas>
      <div class="btn-group">
        <button onclick="clearSignature()">Clear</button>
        <button onclick="saveSignature()">Save</button>
      </div>
      <div id="signature-preview"></div>
    </div>
  </div>

  <script>
    function formatCurrency(value) {
      return value.includes("IDR") ? value : parseInt(value).toLocaleString("id-ID") + " IDR";
    }

    function parseJoinedList(list) {
      return list ? decodeURIComponent(list).split("||").map(item => item.split("|")) : [];
    }

    function groupByCategory(data, categories) {
      const groups = {};
      data.forEach(item => {
        const [name, category, cost, qty, day, amount] = item;
        if (!groups[category]) groups[category] = [];
        groups[category].push([name, cost, qty, day, amount]);
      });
      return groups;
    }

    function loadData() {
      const params = new URLSearchParams(window.location.search);
      const project = params.get("project") || "-";
      const user = params.get("user") || "-";
      const orders = parseJoinedList(params.get("orders"));
      const guardorders = parseJoinedList(params.get("guardorders"));
      const totalEquipments = params.get("totalcostorders") || "0";
      const totalGuards = params.get("totalcostGO") || "0";
      const discount = params.get("discount") || "0%";
      const grandTotal = params.get("grandtotal") || "0";
      const categories = [...new Set(orders.map(o => o[1]))];

      document.getElementById("project-title").textContent = project;
      document.getElementById("user-name").textContent = Customer: ${user};
      document.getElementById("total-equipments-cost").textContent = formatCurrency(totalEquipments);
      document.getElementById("total-guard-cost").textContent = formatCurrency(totalGuards);
      document.getElementById("discount-val").textContent = discount;
      document.getElementById("grand-total-val").textContent = formatCurrency(grandTotal);

      const equipmentContainer = document.getElementById("equipments-table-container");
      const grouped = groupByCategory(orders, categories);

      for (const [cat, items] of Object.entries(grouped)) {
        const table = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML = `
          <tr><th colspan="5">${cat}</th></tr>
          <tr>
            <th>Item</th><th>Cost</th><th>Quantity</th><th>Day</th><th>Amount</th>
          </tr>`;
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        items.forEach(([name, , cost, qty, day, amount]) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${name}</td>
            <td>${formatCurrency(cost)}</td>
            <td>${qty}</td>
            <td>${day}</td>
            <td>${formatCurrency(amount)}</td>`;
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        equipmentContainer.appendChild(table);
      }

      // Guard Table
      const guardBody = document.getElementById("guard-body");
      guardorders.forEach(([subject, cost, qty, day, amount]) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${subject}</td>
          <td>${formatCurrency(cost)}</td>
          <td>${qty}</td>
          <td>${day}</td>
          <td>${formatCurrency(amount)}</td>`;
        guardBody.appendChild(tr);
      });
    }

    // Signature Pad Setup
    const canvas = document.getElementById("signature-pad");
    const ctx = canvas.getContext("2d");
    let drawing = false;

    function resizeCanvas() {
      const ratio = window.devicePixelRatio || 1;
      canvas.width = canvas.offsetWidth * ratio;
      canvas.height = canvas.offsetHeight * ratio;
      canvas.getContext("2d").scale(ratio, ratio);
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    function startDraw(e) {
      drawing = true;
      ctx.beginPath();
      const pos = getPos(e);
      ctx.moveTo(pos.x, pos.y);
    }

    function draw(e) {
      if (!drawing) return;
      const pos = getPos(e);
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
    }

    function stopDraw() {
      drawing = false;
    }

    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      return {
        x: clientX - rect.left,
        y: clientY - rect.top
      };
    }

    canvas.addEventListener("mousedown", startDraw);
    canvas.addEventListener("mousemove", draw);
    canvas.addEventListener("mouseup", stopDraw);
    canvas.addEventListener("mouseleave", stopDraw);
    canvas.addEventListener("touchstart", startDraw);
    canvas.addEventListener("touchmove", draw);
    canvas.addEventListener("touchend", stopDraw);

    function clearSignature() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      document.getElementById("signature-preview").innerHTML = "";
    }

    function saveSignature() {
      const dataURL = canvas.toDataURL();
      const img = document.createElement("img");
      img.src = dataURL;
      img.style.maxWidth = "100%";
      document.getElementById("signature-preview").innerHTML = "";
      document.getElementById("signature-preview").appendChild(img);
    }

    window.onload = loadData;
  </script>
</body>
</html>
