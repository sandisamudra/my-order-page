<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quotation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 16px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .section-title {
      margin-top: 30px;
      font-size: 18px;
      font-weight: bold;
    }
    #signature-pad {
      border: 1px solid #ccc;
      margin-top: 10px;
      width: 100%;
      height: 150px;
      touch-action: none;
    }
    #saved-signature {
      margin-top: 20px;
      text-align: right;
    }
    #saved-signature img {
      width: 200px;
      height: auto;
      display: block;
      margin-left: auto;
    }
    .totals {
      font-weight: bold;
      margin-bottom: 10px;
    }
    .print-button {
      margin-top: 20px;
      margin-bottom: 20px;
    }
    @media print {
      #signature-controls, .print-button {
        display: none;
      }
    }
  </style>
</head>
<body>
  <h1 id="project-name">Quotation</h1>

  <div class="section-title">Order Items</div>
  <table id="orders-table">
    <thead>
      <tr>
        <th>Item</th>
        <th>Category</th>
        <th>Cost</th>
        <th>Qty</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="totals" id="total-orders-cost"></div>

  <div class="section-title">Guard and Others</div>
  <table id="guard-table">
    <thead>
      <tr>
        <th>Item</th>
        <th>Category</th>
        <th>Cost</th>
        <th>Qty</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="totals" id="total-guard-cost"></div>

  <div class="totals">Discount: <span id="discount"></span></div>
  <div class="totals">Grand Total: <span id="grand-total"></span></div>

  <div class="section-title">Customer Signature</div>
  <canvas id="signature-pad"></canvas>
  <div id="signature-controls">
    <button onclick="clearSignature()">Clear</button>
    <button onclick="saveSignature()">Save</button>
  </div>
  <div id="saved-signature"></div>
  <div class="print-button">
    <button onclick="window.print()">Print PDF</button>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);

    const project = params.get("project") || "";
    const orders = params.get("orders") || "";
    const guardorders = params.get("guardorders") || "";
    const totalcostorders = params.get("totalcostorders") || "0";
    const totalcostGO = params.get("totalcostGO") || "0";
    const discount = params.get("discount") || "0";
    const grandtotal = params.get("grandtotal") || "0";
    const user = params.get("user") || "";

    document.getElementById("project-name").textContent = `Quotation for ${project}`;
    document.getElementById("total-orders-cost").textContent = `Total Cost (Alat): Rp${formatCurrency(totalcostorders)}`;
    document.getElementById("total-guard-cost").textContent = `Total Cost (Guard and Others): Rp${formatCurrency(totalcostGO)}`;
    document.getElementById("discount").textContent = `Rp${formatCurrency(discount)}`;
    document.getElementById("grand-total").textContent = `Rp${formatCurrency(grandtotal)}`;

    function formatCurrency(num) {
      return parseInt(num || 0).toLocaleString("id-ID");
    }

    function populateTable(data, tableBodyId) {
      const tbody = document.getElementById(tableBodyId);
      if (!data) return;

      const rows = data.split("||");
      rows.forEach(row => {
        const [item, category, cost, qty, total] = row.split("|");
        if (item) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${item}</td>
            <td>${category}</td>
            <td>Rp${formatCurrency(cost)}</td>
            <td>${qty}</td>
            <td>Rp${formatCurrency(total)}</td>
          `;
          tbody.appendChild(tr);
        }
      });
    }

    populateTable(orders, "orders-table").toString;
    populateTable(guardorders, "guard-table").toString;

    // Signature pad
    const canvas = document.getElementById("signature-pad");
    const ctx = canvas.getContext("2d");
    let isDrawing = false;

    canvas.addEventListener("mousedown", startDraw);
    canvas.addEventListener("mousemove", draw);
    canvas.addEventListener("mouseup", stopDraw);
    canvas.addEventListener("touchstart", startDraw, { passive: true });
    canvas.addEventListener("touchmove", drawTouch, { passive: true });
    canvas.addEventListener("touchend", stopDraw);

    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: (e.clientX || e.touches[0].clientX) - rect.left,
        y: (e.clientY || e.touches[0].clientY) - rect.top,
      };
    }

    function startDraw(e) {
      isDrawing = true;
      const { x, y } = getPos(e);
      ctx.beginPath();
      ctx.moveTo(x, y);
    }

    function draw(e) {
      if (!isDrawing) return;
      const { x, y } = getPos(e);
      ctx.lineTo(x, y);
      ctx.stroke();
    }

    function drawTouch(e) {
      if (!isDrawing) return;
      const { x, y } = getPos(e);
      ctx.lineTo(x, y);
      ctx.stroke();
    }

    function stopDraw() {
      isDrawing = false;
      ctx.closePath();
    }

    function clearSignature() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      document.getElementById("saved-signature").innerHTML = "";
    }

    function saveSignature() {
      const dataURL = canvas.toDataURL();
      document.getElementById("saved-signature").innerHTML = `
        <div>Customer Signature:</div>
        <img src="${dataURL}" alt="Signature">
        <div>${user}</div>
      `;
    }
  </script>
</body>
</html>
